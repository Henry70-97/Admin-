<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Receipt Management System</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: linear-gradient(135deg,#e9eff5,#fdfefe);
  padding: 20px;
}

.container {
  max-width: 560px;
  margin: auto;
}

.card {
  background: white;
  padding: 18px;
  border-radius: 14px;
  box-shadow: 0 12px 30px rgba(0,0,0,.08);
  margin-bottom: 15px;
}

.logo {
  text-align: center;
}
.logo img {
  height: 60px;
}

h2 {
  text-align: center;
  margin: 10px 0;
}

input, textarea, select, button {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

button {
  background: #2563eb;
  color: white;
  border: none;
  font-weight: bold;
  cursor: pointer;
}

button:hover {
  background: #1e4fd8;
}

.preview-img {
  width: 100%;
  border-radius: 10px;
  margin-top: 10px;
}

.field {
  font-size: 14px;
  margin-bottom: 6px;
}

.label {
  font-weight: bold;
}

.badge {
  padding: 6px;
  text-align: center;
  font-weight: bold;
  border-radius: 8px;
  margin-top: 8px;
}

.approved { background:#dcfce7; color:#166534; }
.rejected { background:#fee2e2; color:#7f1d1d; }

.feedback {
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
  display: none;
}

.success { background:#ecfeff; color:#065f46; }
.error { background:#fee2e2; color:#7f1d1d; }

.footer {
  text-align: center;
  font-size: 12px;
  color: #777;
}
</style>
</head>

<body>

<div class="container">

  <!-- HEADER -->
  <div class="card">
    <div class="logo"><img src="logo.png"></div>
    <h2>Payment Receipt</h2>
  </div>

  <!-- IMAGE UPLOAD -->
  <div class="card">
    <input type="file" accept="image/*" id="image" onchange="previewImage()">
    <img id="imagePreview" class="preview-img" style="display:none">
    <button onclick="extract()">Extract From Image</button>
    <div id="feedback" class="feedback"></div>
  </div>

  <!-- RECEIPT PREVIEW -->
  <div class="card">
    <h3>Receipt Preview</h3>
    <div id="receipt"></div>
  </div>

  <!-- ADMIN ACTIONS -->
  <div class="card">
    <textarea id="remarks" placeholder="Admin remarks (optional)"></textarea>
    <select id="status" onchange="updateStatus()">
      <option value="APPROVED">Approved</option>
      <option value="REJECTED">Rejected</option>
    </select>
    <div id="statusBadge" class="badge approved">APPROVED</div>
    <button onclick="downloadPDF()">Download PDF</button>
  </div>

  <div class="footer">System Generated â€¢ Secure & Verifiable</div>
</div>

<script>
let receiptData = {};

function showFeedback(msg, type="success") {
  const fb = document.getElementById("feedback");
  fb.innerText = msg;
  fb.className = `feedback ${type}`;
  fb.style.display = "block";
}

function previewImage() {
  const file = document.getElementById("image").files[0];
  if (!file) return;

  const img = document.getElementById("imagePreview");
  img.src = URL.createObjectURL(file);
  img.style.display = "block";
  showFeedback("Image uploaded successfully");
}

function generateReceiptNo() {
  return "RCP-" + Date.now();
}

async function extract() {
  const image = document.getElementById("image").files[0];
  if (!image) {
    showFeedback("Please upload an image first", "error");
    return;
  }

  const result = await Tesseract.recognize(image, 'eng');
  const text = result.data.text;

  receiptData = {
    receiptNo: generateReceiptNo(),
    transaction: text.match(/[A-Z0-9]{10,}/)?.[0] || "N/A",
    phone: text.match(/07\d{8}/)?.[0] || "N/A",
    amount: text.match(/Ksh\s?([\d.]+)/i)?.[1] || "N/A",
    recipient: text.match(/to\s([A-Z\s]+LIMITED)/i)?.[1] || "N/A",
    date: text.match(/\d{1,2}\/\d{1,2}\/\d{2}/)?.[0] || "N/A",
    timestamp: new Date().toLocaleString()
  };

  renderReceipt();
  showFeedback("Receipt details extracted successfully");
}

function renderReceipt() {
  document.getElementById("receipt").innerHTML = `
    <div class="field"><span class="label">Receipt No:</span> ${receiptData.receiptNo}</div>
    <div class="field"><span class="label">Transaction:</span> ${receiptData.transaction}</div>
    <div class="field"><span class="label">Phone:</span> ${receiptData.phone}</div>
    <div class="field"><span class="label">Amount:</span> KES ${receiptData.amount}</div>
    <div class="field"><span class="label">Recipient:</span> ${receiptData.recipient}</div>
    <div class="field"><span class="label">Date:</span> ${receiptData.date}</div>
    <div class="field"><span class="label">Timestamp:</span> ${receiptData.timestamp}</div>
  `;
}

function updateStatus() {
  const status = document.getElementById("status").value;
  const badge = document.getElementById("statusBadge");

  badge.innerText = status;
  badge.className = `badge ${status === "APPROVED" ? "approved" : "rejected"}`;
  showFeedback(`Receipt marked as ${status}`);
}

function downloadPDF() {
  if (!receiptData.receiptNo) {
    showFeedback("Extract receipt before downloading", "error");
    return;
  }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  pdf.addImage("logo.png","PNG",75,10,60,20);
  pdf.text("PAYMENT RECEIPT",70,40);

  let y = 55;
  for (let k in receiptData) {
    pdf.text(`${k.toUpperCase()}: ${receiptData[k]}`,20,y);
    y += 7;
  }

  pdf.text(`STATUS: ${document.getElementById("status").value}`,20,y+5);
  pdf.text(`REMARKS: ${document.getElementById("remarks").value || "None"}`,20,y+12);

  pdf.setTextColor(180);
  pdf.text("SYSTEM GENERATED",60,285);

  pdf.save(`${receiptData.receiptNo}.pdf`);
  showFeedback("PDF downloaded successfully");
}
</script>

</body>
</html>